# Настройка Supabase

## Шаги для подключения Supabase

### 1. Создайте проект в Supabase

1. Перейдите на [supabase.com](https://supabase.com)
2. Создайте новый проект или используйте существующий
3. Запомните URL проекта и Anon Key

### 2. Настройте переменные окружения

Создайте файл `.env` в корне проекта со следующим содержимым:

```env
VITE_SUPABASE_URL=your_supabase_project_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
```

**Где найти эти значения:**
- Откройте ваш проект в Supabase Dashboard
- Перейдите в **Settings** → **API**
- Скопируйте:
  - **Project URL** → `VITE_SUPABASE_URL`
  - **anon public** key → `VITE_SUPABASE_ANON_KEY`

### 3. Создайте таблицы в Supabase

1. Откройте **SQL Editor** в Supabase Dashboard
2. Скопируйте содержимое файла `database.sql`
3. Выполните SQL запрос

Это создаст:
- Таблицу `users` с полями:
  - `id` (UUID)
  - `wallet_address` (TEXT, уникальный)
  - `balance` (NUMERIC) - баланс пользователя в CLT
  - `created_at`, `updated_at` (TIMESTAMP)
- Таблицу `tickets` с полями:
  - `id` (SERIAL)
  - `owner` (TEXT) - адрес кошелька владельца
  - `type` (TEXT) - тип билета: 'gold', 'silver', 'bronze'
  - `status` (TEXT) - статус: 'available', 'in_draw', 'used'
  - `image` (TEXT, опционально)
  - `created_at` (TIMESTAMP)

### 4. Проверьте Row Level Security (RLS)

Таблицы уже настроены с политиками безопасности, которые разрешают:
- Чтение данных всем пользователям
- Вставку данных всем пользователям
- Обновление данных всем пользователям

Если нужна более строгая безопасность, настройте политики в разделе **Authentication** → **Policies**.

## Как это работает

1. **При подключении кошелька:**
   - Проверяется, существует ли пользователь с таким `wallet_address`
   - Если нет - создается новый пользователь с балансом 0
   - Если есть - загружаются его данные

2. **Баланс пользователя:**
   - Хранится в таблице `users` в поле `balance`
   - Обновляется автоматически при изменениях

3. **Билеты пользователя:**
   - Загружаются из таблицы `tickets` по полю `owner`
   - `owner` должен совпадать с `wallet_address` пользователя (в нижнем регистре)

## Важные замечания

- Адреса кошельков сохраняются в **нижнем регистре** для единообразия
- Баланс хранится как `NUMERIC(20, 2)` для точности
- Все временные метки автоматически обновляются



